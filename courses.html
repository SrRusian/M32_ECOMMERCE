<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MOLINO32 - Cursos</title>
    <link rel="stylesheet" href="styles/general.css" />
    <link rel="stylesheet" href="styles/navbar.css" />
    <link rel="stylesheet" href="styles/courses.css" />
    <link rel="stylesheet" href="styles/footer.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- NAVBAR IMPORT -->
    <div id="site-header"></div>
    <script src="/scripts/header-loader.js" defer></script>

    <main class="courses-section">
      <div
        class="container"
        style="max-width: 1200px; margin: 0 auto; padding: 48px 24px"
      >
        <h1>Todos los Cursos</h1>
        <p>Descubre nuestra colección completa de cursos culinarios</p>

        <div class="courses-filter" id="courses-filter">
          <!-- botones estáticos de ejemplo, usa data-id matching id_category -->
          <button class="filter-btn active" data-id="all">
            <i class="bx bx-grid-alt"></i> Todos los Cursos
          </button>
          <button class="filter-btn" data-id="1">
            <i class="bx bx-restaurant"></i> Cocina Italiana
          </button>
          <button class="filter-btn" data-id="2">
            <i class="bx bx-cake"></i> Repostería
          </button>
          <button class="filter-btn" data-id="3">
            <i class="bx bx-food-menu"></i> Cocina Mexicana
          </button>
          <button class="filter-btn" data-id="4">
            <i class="bx bx-noodles"></i> Cocina Asiática
          </button>
          <button class="filter-btn" data-id="5">
            <i class="bx bx-baguette"></i> Panadería
          </button>
          <button class="filter-btn" data-id="6">
            <i class="bx bx-leaf"></i> Cocina Vegana
          </button>
        </div>

        <div class="courses-cards" id="courses-cards">
          <!-- cards renderizadas aquí -->
        </div>
      </div>
    </main>

    <script>
      async function loadCourses() {
        try {
          const res = await fetch("https://molino32.com/api/get-courses.php");
          if (!res.ok) throw new Error("Network error");
          const json = await res.json();
          if (!json.success) throw new Error("API error");
          const courses = json.data || [];
          window._courses = courses; // cache local para filtros
          renderCourses(courses);

          // init filtros
          document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll(".filter-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
              const id = btn.getAttribute("data-id");
              if (id === "all") renderCourses(window._courses);
              else
                renderCourses(
                  window._courses.filter(
                    (c) => String(c.id_category) === String(id)
                  )
                );
            });
          });
        } catch (err) {
          console.error(err);
          document.getElementById("courses-cards").innerHTML =
            "<p>Error al cargar cursos.</p>";
        }
      }

      function renderCourses(list) {
        const container = document.getElementById("courses-cards");
        container.innerHTML = "";
        if (!list.length) {
          container.innerHTML = "<p>No hay cursos en esta categoría.</p>";
          return;
        }
        list.forEach((c) => {
          const price = formatPrice(c.price);
          const oldPrice = c.old_price
            ? `<span class="featured-old-price">${formatPrice(
                c.old_price
              )}</span>`
            : "";
          const discount = c.discount
            ? `<div class="featured-discount">${c.discount}% OFF</div>`
            : "";
          const img = c.img || "assets/images/placeholder.jpg";
          const rating = c.rating ? c.rating : "0";
          const time = c.time ? `${c.time} h` : "";
          const lessons = c.sections ?? c.lessons ?? "";
          const users = c.users ?? "";
          const categoryName =
            c.category_name || c.category || mapCategoryName(c.id_category);

          const card = document.createElement("div");
          card.className = "featured-card";
          card.innerHTML = `
            <div class="featured-card-img">
              <img src="${escapeHtml(img)}" alt="${escapeHtml(
            c.alt || c.name || ""
          )}">
              ${discount}
              <button class="featured-fav" title="Agregar a favoritos"><i class="bx bx-heart"></i></button>
            </div>
            <div class="featured-card-body">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="featured-level">${escapeHtml(categoryName)}</span>
                <span class="featured-rating"><i class="bx bxs-star"></i> ${escapeHtml(
                  rating
                )}</span>
              </div>
              <h3>${escapeHtml(c.name || c.title || "")}</h3>
              <p class="featured-chef">Por ${escapeHtml(
                c.author || c.chef || "Instructor"
              )}</p>
              <p class="featured-desc">${escapeHtml(
                (c.description || "").slice(0, 160)
              )}</p>

              <div class="featured-info">
                <span title="Duración"><i class="bx bx-time"></i> ${escapeHtml(
                  time
                )}</span>
                <span title="Lecciones"><i class="bx bx-book-open"></i> ${escapeHtml(
                  lessons
                )}</span>
                <span title="Alumnos"><i class="bx bx-group"></i> ${escapeHtml(
                  users
                )}</span>
                <span title="Categoria" style="margin-left:auto"><i class="bx bx-tag"></i> ${escapeHtml(
                  categoryName
                )}</span>
              </div>

              <div class="featured-price-row">
                <div>
                  <span class="featured-price">${price}</span>
                  ${oldPrice}
                </div>
                <button class="featured-cart" onclick="addToCart(${
                  c.id
                })">Agregar al Carrito</button>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function mapCategoryName(id) {
        const map = {
          1: "Cocina Italiana",
          2: "Repostería",
          3: "Cocina Mexicana",
          4: "Cocina Asiática",
          5: "Panadería",
          6: "Cocina Vegana",
        };
        return map[String(id)] || "General";
      }

      function formatPrice(n) {
        if (n === null || n === undefined || n === "") return "$0.00";
        return "$" + Number(n).toFixed(2);
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function addToCart(id) {
        console.log("Agregar al carrito", id);
      }

      document.addEventListener("DOMContentLoaded", loadCourses);
    </script>

    <!-- FOOTER IMPORT -->
    <div id="site-footer"></div>
    <script src="/scripts/footer-loader.js" defer></script>
  </body>
</html>
